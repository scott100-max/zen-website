<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visitor Tracker â€” Salus Admin</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0f1117; color: #e0e0e0; }

    /* Login overlay */
    #login-overlay {
      position: fixed; inset: 0; z-index: 9999;
      background: #0f1117;
      display: flex; align-items: center; justify-content: center;
    }
    .login-box {
      background: #1a1d27; border-radius: 12px; padding: 40px;
      width: 360px; text-align: center; border: 1px solid #2a2d3a;
    }
    .login-box h1 { font-size: 1.4rem; margin-bottom: 8px; color: #fff; }
    .login-box p { font-size: 0.85rem; color: #888; margin-bottom: 24px; }
    .login-box input {
      width: 100%; padding: 12px 16px; margin-bottom: 12px;
      background: #0f1117; border: 1px solid #2a2d3a; border-radius: 8px;
      color: #fff; font-size: 0.95rem; outline: none;
    }
    .login-box input:focus { border-color: #6c63ff; }
    .login-box button {
      width: 100%; padding: 12px; background: #6c63ff; color: #fff;
      border: none; border-radius: 8px; font-size: 0.95rem; cursor: pointer;
      font-weight: 600;
    }
    .login-box button:hover { background: #5a52e0; }
    .login-error { color: #ff6b6b; font-size: 0.85rem; margin-top: 8px; display: none; }

    /* Dashboard layout */
    #dashboard { display: none; }
    .dash-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 16px 24px; background: #1a1d27; border-bottom: 1px solid #2a2d3a;
    }
    .dash-header h1 { font-size: 1.2rem; color: #fff; }
    .dash-header-right { display: flex; align-items: center; gap: 12px; }
    .auto-refresh-toggle {
      display: flex; align-items: center; gap: 6px; font-size: 0.8rem; color: #888;
    }
    .auto-refresh-toggle input { accent-color: #6c63ff; }
    .btn-logout {
      padding: 6px 14px; background: transparent; border: 1px solid #2a2d3a;
      border-radius: 6px; color: #888; font-size: 0.8rem; cursor: pointer;
    }
    .btn-logout:hover { border-color: #ff6b6b; color: #ff6b6b; }

    /* Stats bar */
    .stats-bar {
      display: flex; gap: 16px; padding: 16px 24px; flex-wrap: wrap;
    }
    .stat-card {
      background: #1a1d27; border: 1px solid #2a2d3a; border-radius: 10px;
      padding: 16px 24px; min-width: 140px; flex: 1;
    }
    .stat-card .label { font-size: 0.75rem; color: #888; text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-card .value { font-size: 1.8rem; font-weight: 700; color: #fff; margin-top: 4px; }

    /* Filter bar */
    .filter-bar {
      display: flex; gap: 8px; padding: 0 24px 16px; flex-wrap: wrap; align-items: center;
    }
    .filter-btn {
      padding: 6px 16px; border-radius: 20px; border: 1px solid #2a2d3a;
      background: transparent; color: #aaa; font-size: 0.8rem; cursor: pointer;
    }
    .filter-btn.active { background: #6c63ff; border-color: #6c63ff; color: #fff; }
    .filter-btn:hover:not(.active) { border-color: #6c63ff; color: #6c63ff; }

    /* Map */
    #map {
      height: 50vh; margin: 0 24px; border-radius: 12px;
      border: 1px solid #2a2d3a; overflow: hidden;
    }

    /* Tables section */
    .tables-section {
      display: grid; grid-template-columns: 1fr 1fr 2fr; gap: 16px;
      padding: 16px 24px;
    }
    @media (max-width: 1200px) { .tables-section { grid-template-columns: 1fr 1fr; } }
    @media (max-width: 768px) { .tables-section { grid-template-columns: 1fr; } }

    .table-card {
      background: #1a1d27; border: 1px solid #2a2d3a; border-radius: 10px;
      padding: 16px; overflow: auto;
    }
    .table-card h3 {
      font-size: 0.85rem; color: #888; text-transform: uppercase;
      letter-spacing: 0.5px; margin-bottom: 12px;
    }
    .table-card table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    .table-card th {
      text-align: left; padding: 8px 10px; border-bottom: 1px solid #2a2d3a;
      color: #888; font-weight: 500; font-size: 0.75rem; text-transform: uppercase;
    }
    .table-card td { padding: 8px 10px; border-bottom: 1px solid #1e2130; }
    .table-card tr:last-child td { border-bottom: none; }
    .table-card .rank { color: #6c63ff; font-weight: 600; }
    .table-card .count { color: #6c63ff; font-weight: 600; text-align: right; }

    /* Loading spinner */
    .loading { text-align: center; padding: 40px; color: #888; }
    .loading::after { content: ''; display: inline-block; width: 20px; height: 20px;
      border: 2px solid #2a2d3a; border-top-color: #6c63ff; border-radius: 50%;
      animation: spin 0.8s linear infinite; margin-left: 8px; vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Dark map tiles */
    .leaflet-container { background: #1a1d27; }
  </style>
</head>
<body>

  <!-- Login Overlay -->
  <div id="login-overlay">
    <div class="login-box">
      <h1>Salus Admin</h1>
      <p>Visitor location tracker</p>
      <input type="email" id="login-email" placeholder="Email" autocomplete="email">
      <input type="password" id="login-password" placeholder="Password" autocomplete="current-password">
      <button id="login-btn" onclick="doLogin()">Sign In</button>
      <div class="login-error" id="login-error"></div>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard">
    <div class="dash-header">
      <h1>Visitor Tracker</h1>
      <div class="dash-header-right">
        <label class="auto-refresh-toggle">
          <input type="checkbox" id="auto-refresh"> Auto-refresh (30s)
        </label>
        <button class="btn-logout" onclick="doLogout()">Sign Out</button>
      </div>
    </div>

    <div class="stats-bar">
      <div class="stat-card"><div class="label">Total</div><div class="value" id="stat-total">-</div></div>
      <div class="stat-card"><div class="label">Today</div><div class="value" id="stat-today">-</div></div>
      <div class="stat-card"><div class="label">7 Days</div><div class="value" id="stat-7d">-</div></div>
      <div class="stat-card"><div class="label">30 Days</div><div class="value" id="stat-30d">-</div></div>
    </div>

    <div class="filter-bar">
      <button class="filter-btn active" data-range="all">All Time</button>
      <button class="filter-btn" data-range="30">Last 30 Days</button>
      <button class="filter-btn" data-range="7">Last 7 Days</button>
      <button class="filter-btn" data-range="1">Today</button>
    </div>

    <div id="map"></div>

    <div class="tables-section">
      <div class="table-card">
        <h3>Top Countries</h3>
        <table id="countries-table"><tbody></tbody></table>
      </div>
      <div class="table-card">
        <h3>Top Cities</h3>
        <table id="cities-table"><tbody></tbody></table>
      </div>
      <div class="table-card">
        <h3>Recent Visitors</h3>
        <table id="recent-table">
          <thead><tr><th>Time</th><th>Location</th><th>Page</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script>
    // ===== Supabase init =====
    var SUPABASE_URL = 'https://egywowuyixfqytaucihf.supabase.co';
    var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVneXdvd3V5aXhmcXl0YXVjaWhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyNzE0OTgsImV4cCI6MjA4NTg0NzQ5OH0.XMA7XDaQocuWQKq6kMuPOy6J3qGJ4k8h5T2p2JdEFJI';
    var sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ===== State =====
    var map, markerGroup;
    var allData = [];
    var currentRange = 'all';
    var refreshTimer = null;

    // ===== Login =====
    async function doLogin() {
      var email = document.getElementById('login-email').value.trim();
      var password = document.getElementById('login-password').value;
      var errEl = document.getElementById('login-error');
      errEl.style.display = 'none';

      if (!email || !password) { errEl.textContent = 'Enter email and password.'; errEl.style.display = 'block'; return; }

      var { error } = await sb.auth.signInWithPassword({ email: email, password: password });
      if (error) { errEl.textContent = 'Access denied.'; errEl.style.display = 'block'; return; }

      document.getElementById('login-overlay').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      initDashboard();
    }

    async function doLogout() {
      await sb.auth.signOut();
      location.reload();
    }

    // Allow enter key to submit
    document.getElementById('login-password').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') doLogin();
    });

    // Check existing session on load
    (async function() {
      var { data } = await sb.auth.getSession();
      if (data.session) {
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        initDashboard();
      }
    })();

    // ===== Dashboard =====
    async function initDashboard() {
      initMap();
      await loadData();
      setupFilters();
      setupAutoRefresh();
    }

    function initMap() {
      map = L.map('map', { zoomControl: true }).setView([30, 0], 2);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap &copy; CARTO',
        maxZoom: 18
      }).addTo(map);
      markerGroup = L.markerClusterGroup({
        maxClusterRadius: 50,
        spiderfyOnMaxZoom: true,
        iconCreateFunction: function(cluster) {
          var count = cluster.getChildCount();
          var size = count < 10 ? 'small' : count < 50 ? 'medium' : 'large';
          var sizes = { small: 36, medium: 46, large: 56 };
          return L.divIcon({
            html: '<div style="background:rgba(108,99,255,0.85);color:#fff;border-radius:50%;width:' + sizes[size] + 'px;height:' + sizes[size] + 'px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:' + (size === 'large' ? '14' : '12') + 'px;border:2px solid rgba(108,99,255,0.4);">' + count + '</div>',
            className: '', iconSize: L.point(sizes[size], sizes[size])
          });
        }
      });
      map.addLayer(markerGroup);
    }

    async function loadData() {
      var { data, error } = await sb
        .from('visitor_logs')
        .select('*')
        .order('created_at', { ascending: false })
        .limit(5000);

      if (error) { console.error('Load error:', error); return; }
      allData = data || [];
      updateDisplay();
    }

    function updateDisplay() {
      var filtered = filterByRange(allData, currentRange);
      updateStats();
      updateMap(filtered);
      updateCountries(filtered);
      updateCities(filtered);
      updateRecent(filtered);
    }

    function filterByRange(data, range) {
      if (range === 'all') return data;
      var days = parseInt(range);
      var cutoff = new Date();
      cutoff.setDate(cutoff.getDate() - days);
      return data.filter(function(r) { return new Date(r.created_at) >= cutoff; });
    }

    // ===== Stats =====
    function updateStats() {
      var now = new Date();
      var todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      var d7 = new Date(); d7.setDate(d7.getDate() - 7);
      var d30 = new Date(); d30.setDate(d30.getDate() - 30);

      document.getElementById('stat-total').textContent = allData.length.toLocaleString();
      document.getElementById('stat-today').textContent = allData.filter(function(r) { return new Date(r.created_at) >= todayStart; }).length.toLocaleString();
      document.getElementById('stat-7d').textContent = allData.filter(function(r) { return new Date(r.created_at) >= d7; }).length.toLocaleString();
      document.getElementById('stat-30d').textContent = allData.filter(function(r) { return new Date(r.created_at) >= d30; }).length.toLocaleString();
    }

    // ===== Map =====
    function updateMap(data) {
      markerGroup.clearLayers();
      data.forEach(function(r) {
        if (!r.latitude || !r.longitude) return;
        var marker = L.circleMarker([r.latitude, r.longitude], {
          radius: 6, fillColor: '#6c63ff', color: '#6c63ff',
          weight: 1, opacity: 0.8, fillOpacity: 0.6
        });
        var time = new Date(r.created_at).toLocaleString();
        marker.bindPopup(
          '<div style="font-size:13px;line-height:1.5;">' +
          '<strong>' + (r.city || 'Unknown') + ', ' + (r.country || 'Unknown') + '</strong><br>' +
          '<span style="color:#888;">Page:</span> ' + escHtml(r.landing_page || '/') + '<br>' +
          '<span style="color:#888;">Time:</span> ' + time +
          '</div>'
        );
        markerGroup.addLayer(marker);
      });
    }

    // ===== Country table =====
    function updateCountries(data) {
      var counts = {};
      data.forEach(function(r) { var c = r.country || 'Unknown'; counts[c] = (counts[c] || 0) + 1; });
      var sorted = Object.entries(counts).sort(function(a, b) { return b[1] - a[1]; }).slice(0, 10);
      var tbody = document.querySelector('#countries-table tbody');
      tbody.innerHTML = sorted.map(function(entry, i) {
        return '<tr><td class="rank">' + (i + 1) + '</td><td>' + escHtml(entry[0]) + '</td><td class="count">' + entry[1] + '</td></tr>';
      }).join('') || '<tr><td colspan="3" style="color:#666;">No data</td></tr>';
    }

    // ===== City table =====
    function updateCities(data) {
      var counts = {};
      data.forEach(function(r) {
        var key = (r.city || 'Unknown') + ', ' + (r.country || '');
        counts[key] = (counts[key] || 0) + 1;
      });
      var sorted = Object.entries(counts).sort(function(a, b) { return b[1] - a[1]; }).slice(0, 10);
      var tbody = document.querySelector('#cities-table tbody');
      tbody.innerHTML = sorted.map(function(entry, i) {
        return '<tr><td class="rank">' + (i + 1) + '</td><td>' + escHtml(entry[0]) + '</td><td class="count">' + entry[1] + '</td></tr>';
      }).join('') || '<tr><td colspan="3" style="color:#666;">No data</td></tr>';
    }

    // ===== Recent visitors table =====
    function updateRecent(data) {
      var recent = data.slice(0, 50);
      var tbody = document.querySelector('#recent-table tbody');
      tbody.innerHTML = recent.map(function(r) {
        var t = new Date(r.created_at);
        var timeStr = t.toLocaleDateString(undefined, { month: 'short', day: 'numeric' }) + ' ' + t.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
        return '<tr><td style="white-space:nowrap;">' + timeStr + '</td>' +
          '<td>' + escHtml((r.city || '?') + ', ' + (r.country || '?')) + '</td>' +
          '<td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + escHtml(r.landing_page || '/') + '</td></tr>';
      }).join('') || '<tr><td colspan="3" style="color:#666;">No visitors yet</td></tr>';
    }

    // ===== Filters =====
    function setupFilters() {
      document.querySelectorAll('.filter-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.filter-btn').forEach(function(b) { b.classList.remove('active'); });
          btn.classList.add('active');
          currentRange = btn.getAttribute('data-range');
          updateDisplay();
        });
      });
    }

    // ===== Auto-refresh =====
    function setupAutoRefresh() {
      var checkbox = document.getElementById('auto-refresh');
      checkbox.addEventListener('change', function() {
        if (checkbox.checked) {
          refreshTimer = setInterval(loadData, 30000);
        } else {
          clearInterval(refreshTimer);
          refreshTimer = null;
        }
      });
    }

    // ===== Util =====
    function escHtml(str) {
      var div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }
  </script>
</body>
</html>

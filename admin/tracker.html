<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visitor Tracker — Salus Admin</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0f1117; color: #e0e0e0; }

    /* Login overlay */
    #login-overlay {
      position: fixed; inset: 0; z-index: 9999;
      background: #0f1117;
      display: flex; align-items: center; justify-content: center;
    }
    .login-box {
      background: #1a1d27; border-radius: 12px; padding: 40px;
      width: 360px; text-align: center; border: 1px solid #2a2d3a;
    }
    .login-box h1 { font-size: 1.4rem; margin-bottom: 8px; color: #fff; }
    .login-box p { font-size: 0.85rem; color: #888; margin-bottom: 24px; }
    .login-box input {
      width: 100%; padding: 12px 16px; margin-bottom: 12px;
      background: #0f1117; border: 1px solid #2a2d3a; border-radius: 8px;
      color: #fff; font-size: 0.95rem; outline: none;
    }
    .login-box input:focus { border-color: #6c63ff; }
    .login-box button {
      width: 100%; padding: 12px; background: #6c63ff; color: #fff;
      border: none; border-radius: 8px; font-size: 0.95rem; cursor: pointer;
      font-weight: 600;
    }
    .login-box button:hover { background: #5a52e0; }
    .login-error { color: #ff6b6b; font-size: 0.85rem; margin-top: 8px; display: none; }

    /* Dashboard layout */
    #dashboard { display: none; }
    .dash-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 16px 24px; background: #1a1d27; border-bottom: 1px solid #2a2d3a;
    }
    .dash-header h1 { font-size: 1.2rem; color: #fff; }
    .dash-header-right { display: flex; align-items: center; gap: 12px; }
    .auto-refresh-toggle {
      display: flex; align-items: center; gap: 6px; font-size: 0.8rem; color: #888;
    }
    .auto-refresh-toggle input { accent-color: #6c63ff; }
    .btn-logout {
      padding: 6px 14px; background: transparent; border: 1px solid #2a2d3a;
      border-radius: 6px; color: #888; font-size: 0.8rem; cursor: pointer;
    }
    .btn-logout:hover { border-color: #ff6b6b; color: #ff6b6b; }

    /* Stats bar */
    .stats-bar {
      display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; padding: 16px 24px;
    }
    @media (max-width: 900px) { .stats-bar { grid-template-columns: repeat(2, 1fr); } }
    .stat-card {
      background: #1a1d27; border: 1px solid #2a2d3a; border-radius: 10px;
      padding: 14px 20px;
    }
    .stat-card .label { font-size: 0.7rem; color: #888; text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-card .value { font-size: 1.6rem; font-weight: 700; color: #fff; margin-top: 2px; }
    .stat-card .sub { font-size: 0.7rem; color: #666; margin-top: 2px; }

    /* Filter bar */
    .filter-bar {
      display: flex; gap: 8px; padding: 0 24px 16px; flex-wrap: wrap; align-items: center;
    }
    .filter-btn {
      padding: 6px 16px; border-radius: 20px; border: 1px solid #2a2d3a;
      background: transparent; color: #aaa; font-size: 0.8rem; cursor: pointer;
    }
    .filter-btn.active { background: #6c63ff; border-color: #6c63ff; color: #fff; }
    .filter-btn:hover:not(.active) { border-color: #6c63ff; color: #6c63ff; }

    /* Map */
    #map {
      height: 45vh; margin: 0 24px; border-radius: 12px;
      border: 1px solid #2a2d3a; overflow: hidden;
    }

    /* Section heading */
    .section-heading {
      font-size: 0.9rem; font-weight: 600; color: #fff; padding: 20px 24px 12px;
      border-top: 1px solid #1e2130; margin-top: 8px;
    }

    /* Tables section */
    .tables-section {
      display: grid; grid-template-columns: 1fr 1fr 2fr; gap: 16px;
      padding: 0 24px 16px;
    }
    .tables-2col {
      display: grid; grid-template-columns: 1fr 1fr; gap: 16px;
      padding: 0 24px 16px;
    }
    .tables-3col {
      display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;
      padding: 0 24px 16px;
    }
    @media (max-width: 1200px) {
      .tables-section { grid-template-columns: 1fr 1fr; }
      .tables-3col { grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 768px) {
      .tables-section, .tables-2col, .tables-3col { grid-template-columns: 1fr; }
    }

    .table-card {
      background: #1a1d27; border: 1px solid #2a2d3a; border-radius: 10px;
      padding: 16px; overflow: auto;
    }
    .table-card h3 {
      font-size: 0.85rem; color: #888; text-transform: uppercase;
      letter-spacing: 0.5px; margin-bottom: 12px;
    }
    .table-card table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    .table-card th {
      text-align: left; padding: 8px 10px; border-bottom: 1px solid #2a2d3a;
      color: #888; font-weight: 500; font-size: 0.75rem; text-transform: uppercase;
    }
    .table-card td { padding: 8px 10px; border-bottom: 1px solid #1e2130; }
    .table-card tr:last-child td { border-bottom: none; }
    .table-card .rank { color: #6c63ff; font-weight: 600; }
    .table-card .count { color: #6c63ff; font-weight: 600; text-align: right; }
    .table-card .dim { color: #666; }
    .table-card .mono { font-family: monospace; font-size: 0.8rem; }
    .table-card .badge {
      display: inline-block; padding: 2px 8px; border-radius: 10px;
      font-size: 0.7rem; font-weight: 600;
    }
    .badge-play { background: rgba(108,99,255,0.2); color: #6c63ff; }
    .badge-pause { background: rgba(255,107,107,0.2); color: #ff6b6b; }
    .badge-complete { background: rgba(72,199,142,0.2); color: #48c78e; }
    .badge-cta { background: rgba(255,183,77,0.2); color: #ffb74d; }
    .badge-scroll { background: rgba(100,181,246,0.2); color: #64b5f6; }
    .badge-view { background: rgba(206,147,216,0.2); color: #ce93d8; }

    /* Loading spinner */
    .loading { text-align: center; padding: 40px; color: #888; }
    .loading::after { content: ''; display: inline-block; width: 20px; height: 20px;
      border: 2px solid #2a2d3a; border-top-color: #6c63ff; border-radius: 50%;
      animation: spin 0.8s linear infinite; margin-left: 8px; vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Dark map tiles */
    .leaflet-container { background: #1a1d27; }

    /* No-data placeholder */
    .no-data { color: #555; font-size: 0.85rem; padding: 16px 0; text-align: center; }
  </style>
</head>
<body>

  <!-- Login Overlay -->
  <div id="login-overlay">
    <div class="login-box">
      <h1>Salus Admin</h1>
      <p>Visitor analytics dashboard</p>
      <input type="email" id="login-email" placeholder="Email" autocomplete="email">
      <input type="password" id="login-password" placeholder="Password" autocomplete="current-password">
      <button id="login-btn" onclick="doLogin()">Sign In</button>
      <div class="login-error" id="login-error"></div>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard">
    <div class="dash-header">
      <h1>Visitor Analytics</h1>
      <div class="dash-header-right">
        <label class="auto-refresh-toggle">
          <input type="checkbox" id="auto-refresh"> Auto-refresh (30s)
        </label>
        <button class="btn-logout" onclick="doLogout()">Sign Out</button>
      </div>
    </div>

    <!-- Stats Row 1 -->
    <div class="stats-bar">
      <div class="stat-card"><div class="label">Total Visitors</div><div class="value" id="stat-visitors">-</div></div>
      <div class="stat-card"><div class="label">New (7d)</div><div class="value" id="stat-new7d">-</div></div>
      <div class="stat-card"><div class="label">Returning</div><div class="value" id="stat-returning">-</div></div>
      <div class="stat-card"><div class="label">Sessions Today</div><div class="value" id="stat-today">-</div></div>
    </div>
    <!-- Stats Row 2 -->
    <div class="stats-bar" style="padding-top:0;">
      <div class="stat-card"><div class="label">Page Views (7d)</div><div class="value" id="stat-pv7d">-</div></div>
      <div class="stat-card"><div class="label">Avg Duration</div><div class="value" id="stat-duration">-</div><div class="sub">seconds</div></div>
      <div class="stat-card"><div class="label">Top Page</div><div class="value" id="stat-toppage" style="font-size:1rem;word-break:break-all;">-</div></div>
      <div class="stat-card"><div class="label">Audio Plays</div><div class="value" id="stat-plays">-</div><div class="sub" id="stat-plays-sub"></div></div>
    </div>

    <div class="filter-bar">
      <button class="filter-btn active" data-range="all">All Time</button>
      <button class="filter-btn" data-range="30">Last 30 Days</button>
      <button class="filter-btn" data-range="7">Last 7 Days</button>
      <button class="filter-btn" data-range="1">Today</button>
      <span style="width:1px;height:20px;background:#2a2d3a;margin:0 4px;"></span>
      <button class="filter-btn" id="exclude-me-btn">Exclude My Region</button>
    </div>

    <div id="map"></div>

    <!-- Geo Tables (existing) -->
    <div class="section-heading">Geography</div>
    <div class="tables-section">
      <div class="table-card">
        <h3>Top Countries</h3>
        <table id="countries-table"><tbody></tbody></table>
      </div>
      <div class="table-card">
        <h3>Top Cities</h3>
        <table id="cities-table"><tbody></tbody></table>
      </div>
      <div class="table-card">
        <h3>Recent Visitors</h3>
        <table id="recent-table">
          <thead><tr><th>Time</th><th>Location</th><th>Page</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Page Analytics -->
    <div class="section-heading">Page Analytics</div>
    <div class="tables-2col">
      <div class="table-card">
        <h3>Top Pages by Views</h3>
        <table id="top-pages-table">
          <thead><tr><th>#</th><th>Page</th><th>Views</th><th>Avg Duration</th><th>Avg Scroll</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="table-card">
        <h3>Landing Pages</h3>
        <table id="landing-pages-table">
          <thead><tr><th>#</th><th>Page</th><th>Sessions</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Traffic Sources -->
    <div class="section-heading">Traffic Sources</div>
    <div class="tables-2col">
      <div class="table-card">
        <h3>Referrers</h3>
        <table id="referrers-table">
          <thead><tr><th>#</th><th>Source</th><th>Visits</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="table-card">
        <h3>UTM Campaigns</h3>
        <table id="utm-table">
          <thead><tr><th>Source</th><th>Medium</th><th>Campaign</th><th>Visits</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Engagement -->
    <div class="section-heading">Engagement</div>
    <div class="tables-3col">
      <div class="table-card">
        <h3>Audio Activity</h3>
        <table id="audio-table">
          <thead><tr><th>Track</th><th>Plays</th><th>Completions</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="table-card">
        <h3>CTA Clicks</h3>
        <table id="cta-table">
          <thead><tr><th>Target</th><th>Label</th><th>Clicks</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="table-card">
        <h3>Scroll Depth Distribution</h3>
        <table id="scroll-table">
          <thead><tr><th>Milestone</th><th>Reached</th><th>% of Views</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Visitor Timeline -->
    <div class="section-heading">Activity Feed</div>
    <div style="padding:0 24px 16px;">
      <div class="table-card">
        <h3>Recent Page Views & Events</h3>
        <table id="timeline-table">
          <thead><tr><th>Time</th><th>Type</th><th>Detail</th><th>Page</th><th>Location</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Returning Visitors -->
    <div class="section-heading">Returning Visitors</div>
    <div style="padding:0 24px 24px;">
      <div class="table-card">
        <h3>Most Active Visitors</h3>
        <table id="returning-table">
          <thead><tr><th>Visitor</th><th>First Seen</th><th>Last Seen</th><th>Sessions</th><th>Location</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script>
    // ===== Supabase init =====
    var SUPABASE_URL = 'https://egywowuyixfqytaucihf.supabase.co';
    var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVneXdvd3V5aXhmcXl0YXVjaWhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyNzE0OTgsImV4cCI6MjA4NTg0NzQ5OH0.XMA7XDaQocuWQKq6kMuPOy6J3qGJ4k8h5T2p2JdEFJI';
    var sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ===== State =====
    var map, markerGroup;
    var currentRange = 'all';
    var refreshTimer = null;
    var excludeMyRegion = false;

    // Bounding box for owner region (West Yorkshire — Wakefield/Pontefract/Castleford)
    var MY_REGION = { latMin: 53.6, latMax: 53.85, lngMin: -1.7, lngMax: -1.2 };

    function isMyRegion(r) {
      if (!r.latitude || !r.longitude) return false;
      return r.latitude >= MY_REGION.latMin && r.latitude <= MY_REGION.latMax &&
             r.longitude >= MY_REGION.lngMin && r.longitude <= MY_REGION.lngMax;
    }

    function applyExclusion(data) {
      if (!excludeMyRegion) return data;
      return data.filter(function(r) { return !isMyRegion(r); });
    }

    // Build set of visitor IDs seen in my region (from page_views + legacy)
    function getMyRegionVisitorIds() {
      var ids = {};
      pageViewsData.forEach(function(pv) { if (isMyRegion(pv) && pv.visitor_id) ids[pv.visitor_id] = true; });
      legacyData.forEach(function(r) { if (isMyRegion(r) && r.visitor_id) ids[r.visitor_id] = true; });
      return ids;
    }

    function applyVisitorExclusion(visitors) {
      if (!excludeMyRegion) return visitors;
      var regionIds = getMyRegionVisitorIds();
      return visitors.filter(function(v) { return !regionIds[v.id]; });
    }

    // Data stores
    var pageViewsData = [];
    var eventsData = [];
    var visitorsData = [];
    var legacyData = []; // visitor_logs for backward compat

    // ===== Login =====
    async function doLogin() {
      var email = document.getElementById('login-email').value.trim();
      var password = document.getElementById('login-password').value;
      var errEl = document.getElementById('login-error');
      errEl.style.display = 'none';

      if (!email || !password) { errEl.textContent = 'Enter email and password.'; errEl.style.display = 'block'; return; }

      var { error } = await sb.auth.signInWithPassword({ email: email, password: password });
      if (error) { errEl.textContent = 'Access denied.'; errEl.style.display = 'block'; return; }

      document.getElementById('login-overlay').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      initDashboard();
    }

    async function doLogout() {
      await sb.auth.signOut();
      location.reload();
    }

    document.getElementById('login-password').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') doLogin();
    });

    (async function() {
      var { data } = await sb.auth.getSession();
      if (data.session) {
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        initDashboard();
      }
    })();

    // ===== Dashboard =====
    async function initDashboard() {
      initMap();
      await loadAllData();
      setupFilters();
      setupAutoRefresh();
    }

    function initMap() {
      map = L.map('map', { zoomControl: true }).setView([30, 0], 2);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap &copy; CARTO',
        maxZoom: 18
      }).addTo(map);
      markerGroup = L.markerClusterGroup({
        maxClusterRadius: 50,
        spiderfyOnMaxZoom: true,
        iconCreateFunction: function(cluster) {
          var count = cluster.getChildCount();
          var size = count < 10 ? 'small' : count < 50 ? 'medium' : 'large';
          var sizes = { small: 36, medium: 46, large: 56 };
          return L.divIcon({
            html: '<div style="background:rgba(108,99,255,0.85);color:#fff;border-radius:50%;width:' + sizes[size] + 'px;height:' + sizes[size] + 'px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:' + (size === 'large' ? '14' : '12') + 'px;border:2px solid rgba(108,99,255,0.4);">' + count + '</div>',
            className: '', iconSize: L.point(sizes[size], sizes[size])
          });
        }
      });
      map.addLayer(markerGroup);
    }

    async function loadAllData() {
      // Load all tables in parallel
      var [pvResult, evResult, visResult, legResult] = await Promise.all([
        sb.from('page_views').select('*').order('created_at', { ascending: false }).limit(5000),
        sb.from('events').select('*').order('created_at', { ascending: false }).limit(5000),
        sb.from('visitors').select('*').order('last_seen', { ascending: false }).limit(2000),
        sb.from('visitor_logs').select('*').order('created_at', { ascending: false }).limit(5000)
      ]);

      pageViewsData = pvResult.data || [];
      eventsData = evResult.data || [];
      visitorsData = visResult.data || [];
      legacyData = legResult.data || [];

      updateAllDisplays();
    }

    function updateAllDisplays() {
      var filtered = applyExclusion(filterByRange(pageViewsData, currentRange));
      var filteredEvents = filterByRange(eventsData, currentRange);
      var filteredLegacy = applyExclusion(filterByRange(legacyData, currentRange));

      updateStats(filtered, filteredEvents);
      // Map: use page_views if available, fall back to legacy
      var mapSource = filtered.length > 0 ? filtered : filteredLegacy;
      updateMap(mapSource);
      updateCountries(mapSource);
      updateCities(mapSource);
      updateRecent(filtered, filteredLegacy);
      updateTopPages(filtered);
      updateLandingPages(filtered);
      updateReferrers(filtered);
      updateUTM(filtered);
      updateAudio(filteredEvents);
      updateCTA(filteredEvents);
      updateScrollDepth(filteredEvents, filtered);
      updateTimeline(filtered, filteredEvents);
      updateReturning();
    }

    function filterByRange(data, range) {
      if (range === 'all') return data;
      var days = parseInt(range);
      var cutoff = new Date();
      cutoff.setDate(cutoff.getDate() - days);
      return data.filter(function(r) { return new Date(r.created_at) >= cutoff; });
    }

    // ===== Stats =====
    function updateStats(pvFiltered, evFiltered) {
      var now = new Date();
      var todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      var d7 = new Date(); d7.setDate(d7.getDate() - 7);

      // Filtered visitors (exclude my region via page_view cross-reference)
      var filteredVisitors = applyVisitorExclusion(visitorsData);

      // Total unique visitors
      document.getElementById('stat-visitors').textContent = filteredVisitors.length.toLocaleString();

      // New visitors in last 7 days
      var new7d = filteredVisitors.filter(function(v) { return new Date(v.first_seen) >= d7; }).length;
      document.getElementById('stat-new7d').textContent = new7d.toLocaleString();

      // Returning visitors (total_sessions > 1)
      var returning = filteredVisitors.filter(function(v) { return v.total_sessions > 1; }).length;
      document.getElementById('stat-returning').textContent = returning.toLocaleString();

      // Sessions today (unique session_ids in page_views today) — use filtered pv data
      var todayPv = applyExclusion(pageViewsData);
      var todayLegacy = applyExclusion(legacyData);
      var todaySessions = {};
      todayPv.forEach(function(pv) {
        if (new Date(pv.created_at) >= todayStart && pv.session_id) {
          todaySessions[pv.session_id] = true;
        }
      });
      // Fall back to legacy if no page_views yet
      if (Object.keys(todaySessions).length === 0) {
        todayLegacy.forEach(function(r) {
          if (new Date(r.created_at) >= todayStart && r.session_id) {
            todaySessions[r.session_id] = true;
          }
        });
      }
      document.getElementById('stat-today').textContent = Object.keys(todaySessions).length.toLocaleString();

      // Page views (7d)
      var pv7d = todayPv.filter(function(pv) { return new Date(pv.created_at) >= d7; }).length;
      document.getElementById('stat-pv7d').textContent = pv7d.toLocaleString();

      // Avg duration
      var durations = pvFiltered.filter(function(pv) { return pv.duration_seconds > 0; });
      if (durations.length > 0) {
        var avg = Math.round(durations.reduce(function(s, pv) { return s + pv.duration_seconds; }, 0) / durations.length);
        document.getElementById('stat-duration').textContent = avg;
      } else {
        document.getElementById('stat-duration').textContent = '-';
      }

      // Top page
      var pageCounts = {};
      pvFiltered.forEach(function(pv) {
        var p = pv.page_path || '/';
        pageCounts[p] = (pageCounts[p] || 0) + 1;
      });
      var topPage = Object.entries(pageCounts).sort(function(a, b) { return b[1] - a[1]; })[0];
      document.getElementById('stat-toppage').textContent = topPage ? topPage[0] : '-';

      // Audio plays
      var plays = evFiltered.filter(function(e) { return e.event_type === 'audio_play'; }).length;
      var completions = evFiltered.filter(function(e) { return e.event_type === 'audio_complete'; }).length;
      document.getElementById('stat-plays').textContent = plays.toLocaleString();
      document.getElementById('stat-plays-sub').textContent = completions > 0 ? completions + ' completed' : '';
    }

    // ===== Map =====
    function updateMap(data) {
      markerGroup.clearLayers();
      // Deduplicate by session — show first page view per session
      var seen = {};
      data.forEach(function(r) {
        if (!r.latitude || !r.longitude) return;
        var key = r.session_id || r.id;
        if (seen[key]) return;
        seen[key] = true;

        var marker = L.circleMarker([r.latitude, r.longitude], {
          radius: 6, fillColor: '#6c63ff', color: '#6c63ff',
          weight: 1, opacity: 0.8, fillOpacity: 0.6
        });
        var time = new Date(r.created_at).toLocaleString();
        var location = (r.city || 'Unknown') + (r.region ? ', ' + r.region : '') + ', ' + (r.country || 'Unknown');
        marker.bindPopup(
          '<div style="font-size:13px;line-height:1.5;">' +
          '<strong>' + escHtml(location) + '</strong><br>' +
          '<span style="color:#888;">Page:</span> ' + escHtml(r.page_path || r.landing_page || '/') + '<br>' +
          '<span style="color:#888;">Time:</span> ' + time +
          '</div>'
        );
        markerGroup.addLayer(marker);
      });
    }

    // ===== Country table =====
    function updateCountries(data) {
      var counts = {};
      data.forEach(function(r) { var c = r.country || 'Unknown'; counts[c] = (counts[c] || 0) + 1; });
      var sorted = Object.entries(counts).sort(function(a, b) { return b[1] - a[1]; }).slice(0, 10);
      var tbody = document.querySelector('#countries-table tbody');
      tbody.innerHTML = sorted.map(function(entry, i) {
        return '<tr><td class="rank">' + (i + 1) + '</td><td>' + escHtml(entry[0]) + '</td><td class="count">' + entry[1] + '</td></tr>';
      }).join('') || '<tr><td colspan="3"><div class="no-data">No data</div></td></tr>';
    }

    // ===== City table =====
    function updateCities(data) {
      var counts = {};
      data.forEach(function(r) {
        var key = (r.city || 'Unknown') + ', ' + (r.country || '');
        counts[key] = (counts[key] || 0) + 1;
      });
      var sorted = Object.entries(counts).sort(function(a, b) { return b[1] - a[1]; }).slice(0, 10);
      var tbody = document.querySelector('#cities-table tbody');
      tbody.innerHTML = sorted.map(function(entry, i) {
        return '<tr><td class="rank">' + (i + 1) + '</td><td>' + escHtml(entry[0]) + '</td><td class="count">' + entry[1] + '</td></tr>';
      }).join('') || '<tr><td colspan="3"><div class="no-data">No data</div></td></tr>';
    }

    // ===== Recent visitors table =====
    function updateRecent(pvData, legData) {
      // Merge page_views and legacy, sort by time
      var combined = [];
      pvData.slice(0, 50).forEach(function(r) {
        combined.push({
          time: r.created_at,
          city: r.city, region: r.region, country: r.country,
          page: r.page_path
        });
      });
      // If no page_views, show legacy
      if (combined.length === 0) {
        legData.slice(0, 50).forEach(function(r) {
          combined.push({
            time: r.created_at,
            city: r.city, region: r.region, country: r.country,
            page: r.landing_page
          });
        });
      }
      combined.sort(function(a, b) { return new Date(b.time) - new Date(a.time); });

      var tbody = document.querySelector('#recent-table tbody');
      tbody.innerHTML = combined.slice(0, 50).map(function(r) {
        var t = new Date(r.time);
        var timeStr = t.toLocaleDateString(undefined, { month: 'short', day: 'numeric' }) + ' ' + t.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
        return '<tr><td style="white-space:nowrap;">' + timeStr + '</td>' +
          '<td>' + escHtml((r.city || '?') + (r.region ? ', ' + r.region : '') + ', ' + (r.country || '?')) + '</td>' +
          '<td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + escHtml(r.page || '/') + '</td></tr>';
      }).join('') || '<tr><td colspan="3"><div class="no-data">No visitors yet</div></td></tr>';
    }

    // ===== Top Pages =====
    function updateTopPages(pvData) {
      var pages = {};
      pvData.forEach(function(pv) {
        var p = pv.page_path || '/';
        if (!pages[p]) pages[p] = { views: 0, totalDur: 0, durCount: 0, totalScroll: 0, scrollCount: 0 };
        pages[p].views++;
        if (pv.duration_seconds > 0) { pages[p].totalDur += pv.duration_seconds; pages[p].durCount++; }
        if (pv.scroll_depth_pct > 0) { pages[p].totalScroll += pv.scroll_depth_pct; pages[p].scrollCount++; }
      });
      var sorted = Object.entries(pages).sort(function(a, b) { return b[1].views - a[1].views; }).slice(0, 15);
      var tbody = document.querySelector('#top-pages-table tbody');
      tbody.innerHTML = sorted.map(function(entry, i) {
        var d = entry[1];
        var avgDur = d.durCount > 0 ? Math.round(d.totalDur / d.durCount) + 's' : '-';
        var avgScroll = d.scrollCount > 0 ? Math.round(d.totalScroll / d.scrollCount) + '%' : '-';
        return '<tr><td class="rank">' + (i + 1) + '</td><td class="mono">' + escHtml(entry[0]) + '</td><td class="count">' + d.views + '</td><td>' + avgDur + '</td><td>' + avgScroll + '</td></tr>';
      }).join('') || '<tr><td colspan="5"><div class="no-data">No page view data yet</div></td></tr>';
    }

    // ===== Landing Pages =====
    function updateLandingPages(pvData) {
      // First page view per session
      var sessions = {};
      // Data is sorted newest-first, so walk backwards to get first per session
      var sorted = pvData.slice().reverse();
      sorted.forEach(function(pv) {
        if (pv.session_id && !sessions[pv.session_id]) {
          sessions[pv.session_id] = pv.page_path || '/';
        }
      });
      var counts = {};
      Object.values(sessions).forEach(function(p) { counts[p] = (counts[p] || 0) + 1; });
      var top = Object.entries(counts).sort(function(a, b) { return b[1] - a[1]; }).slice(0, 10);
      var tbody = document.querySelector('#landing-pages-table tbody');
      tbody.innerHTML = top.map(function(entry, i) {
        return '<tr><td class="rank">' + (i + 1) + '</td><td class="mono">' + escHtml(entry[0]) + '</td><td class="count">' + entry[1] + '</td></tr>';
      }).join('') || '<tr><td colspan="3"><div class="no-data">No data yet</div></td></tr>';
    }

    // ===== Referrers =====
    function updateReferrers(pvData) {
      var counts = {};
      pvData.forEach(function(pv) {
        if (pv.referrer) {
          var host;
          try { host = new URL(pv.referrer).hostname; } catch(e) { host = pv.referrer; }
          counts[host] = (counts[host] || 0) + 1;
        }
      });
      var sorted = Object.entries(counts).sort(function(a, b) { return b[1] - a[1]; }).slice(0, 10);
      var tbody = document.querySelector('#referrers-table tbody');
      tbody.innerHTML = sorted.map(function(entry, i) {
        return '<tr><td class="rank">' + (i + 1) + '</td><td>' + escHtml(entry[0]) + '</td><td class="count">' + entry[1] + '</td></tr>';
      }).join('') || '<tr><td colspan="3"><div class="no-data">No external referrers yet</div></td></tr>';
    }

    // ===== UTM Campaigns =====
    function updateUTM(pvData) {
      var campaigns = {};
      pvData.forEach(function(pv) {
        if (pv.utm_source) {
          var key = (pv.utm_source || '') + '|' + (pv.utm_medium || '') + '|' + (pv.utm_campaign || '');
          if (!campaigns[key]) campaigns[key] = { source: pv.utm_source, medium: pv.utm_medium || '-', campaign: pv.utm_campaign || '-', count: 0 };
          campaigns[key].count++;
        }
      });
      var sorted = Object.values(campaigns).sort(function(a, b) { return b.count - a.count; }).slice(0, 10);
      var tbody = document.querySelector('#utm-table tbody');
      tbody.innerHTML = sorted.map(function(c) {
        return '<tr><td>' + escHtml(c.source) + '</td><td>' + escHtml(c.medium) + '</td><td>' + escHtml(c.campaign) + '</td><td class="count">' + c.count + '</td></tr>';
      }).join('') || '<tr><td colspan="4"><div class="no-data">No UTM data yet</div></td></tr>';
    }

    // ===== Audio Activity =====
    function updateAudio(evData) {
      var tracks = {};
      evData.forEach(function(e) {
        if (e.event_type === 'audio_play' || e.event_type === 'audio_complete') {
          var name = e.event_target || 'Unknown';
          if (!tracks[name]) tracks[name] = { plays: 0, completions: 0 };
          if (e.event_type === 'audio_play') tracks[name].plays++;
          if (e.event_type === 'audio_complete') tracks[name].completions++;
        }
      });
      var sorted = Object.entries(tracks).sort(function(a, b) { return b[1].plays - a[1].plays; }).slice(0, 10);
      var tbody = document.querySelector('#audio-table tbody');
      tbody.innerHTML = sorted.map(function(entry) {
        return '<tr><td>' + escHtml(entry[0]) + '</td><td class="count">' + entry[1].plays + '</td><td class="count">' + entry[1].completions + '</td></tr>';
      }).join('') || '<tr><td colspan="3"><div class="no-data">No audio events yet</div></td></tr>';
    }

    // ===== CTA Clicks =====
    function updateCTA(evData) {
      var ctas = {};
      evData.forEach(function(e) {
        if (e.event_type === 'cta_click') {
          var target = e.event_target || 'unknown';
          if (!ctas[target]) ctas[target] = { label: e.event_value || '-', count: 0 };
          ctas[target].count++;
        }
      });
      var sorted = Object.entries(ctas).sort(function(a, b) { return b[1].count - a[1].count; }).slice(0, 10);
      var tbody = document.querySelector('#cta-table tbody');
      tbody.innerHTML = sorted.map(function(entry) {
        return '<tr><td class="mono">' + escHtml(entry[0]) + '</td><td>' + escHtml(entry[1].label) + '</td><td class="count">' + entry[1].count + '</td></tr>';
      }).join('') || '<tr><td colspan="3"><div class="no-data">No CTA clicks yet</div></td></tr>';
    }

    // ===== Scroll Depth =====
    function updateScrollDepth(evData, pvData) {
      var milestones = { '25%': 0, '50%': 0, '75%': 0, '100%': 0 };
      evData.forEach(function(e) {
        if (e.event_type === 'scroll_milestone' && milestones.hasOwnProperty(e.event_target)) {
          milestones[e.event_target]++;
        }
      });
      var totalViews = pvData.length || 1;
      var tbody = document.querySelector('#scroll-table tbody');
      tbody.innerHTML = ['25%', '50%', '75%', '100%'].map(function(m) {
        var pct = Math.round(milestones[m] / totalViews * 100);
        return '<tr><td><span class="badge badge-scroll">' + m + '</span></td><td class="count">' + milestones[m] + '</td><td>' + pct + '%</td></tr>';
      }).join('');
    }

    // ===== Activity Feed (Timeline) =====
    function updateTimeline(pvData, evData) {
      var items = [];
      pvData.slice(0, 30).forEach(function(pv) {
        items.push({
          time: pv.created_at,
          type: 'page_view',
          detail: pv.page_title || pv.page_path,
          page: pv.page_path,
          location: (pv.city || '') + (pv.country ? ', ' + pv.country : '')
        });
      });
      evData.slice(0, 30).forEach(function(e) {
        items.push({
          time: e.created_at,
          type: e.event_type,
          detail: e.event_target || '-',
          page: e.page_path,
          location: ''
        });
      });
      items.sort(function(a, b) { return new Date(b.time) - new Date(a.time); });

      var tbody = document.querySelector('#timeline-table tbody');
      tbody.innerHTML = items.slice(0, 50).map(function(item) {
        var t = new Date(item.time);
        var timeStr = t.toLocaleDateString(undefined, { month: 'short', day: 'numeric' }) + ' ' + t.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
        var badge = getBadge(item.type);
        return '<tr><td style="white-space:nowrap;">' + timeStr + '</td>' +
          '<td>' + badge + '</td>' +
          '<td style="max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + escHtml(item.detail || '-') + '</td>' +
          '<td class="mono" style="max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + escHtml(item.page || '/') + '</td>' +
          '<td class="dim">' + escHtml(item.location) + '</td></tr>';
      }).join('') || '<tr><td colspan="5"><div class="no-data">No activity yet</div></td></tr>';
    }

    function getBadge(type) {
      var badges = {
        'page_view': '<span class="badge badge-view">View</span>',
        'audio_play': '<span class="badge badge-play">Play</span>',
        'audio_pause': '<span class="badge badge-pause">Pause</span>',
        'audio_complete': '<span class="badge badge-complete">Complete</span>',
        'cta_click': '<span class="badge badge-cta">CTA</span>',
        'scroll_milestone': '<span class="badge badge-scroll">Scroll</span>'
      };
      return badges[type] || '<span class="badge" style="background:rgba(255,255,255,0.1);color:#aaa;">' + escHtml(type) + '</span>';
    }

    // ===== Returning Visitors =====
    function updateReturning() {
      var returning = applyVisitorExclusion(visitorsData).filter(function(v) { return v.total_sessions > 1; });
      returning.sort(function(a, b) { return b.total_sessions - a.total_sessions; });
      var tbody = document.querySelector('#returning-table tbody');
      tbody.innerHTML = returning.slice(0, 20).map(function(v) {
        var first = new Date(v.first_seen).toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
        var last = new Date(v.last_seen).toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
        var loc = (v.city || '?') + (v.country ? ', ' + v.country : '');
        var shortId = v.id.substring(0, 8);
        return '<tr><td class="mono dim">' + shortId + '</td><td>' + first + '</td><td>' + last + '</td><td class="count">' + v.total_sessions + '</td><td class="dim">' + escHtml(loc) + '</td></tr>';
      }).join('') || '<tr><td colspan="5"><div class="no-data">No returning visitors yet</div></td></tr>';
    }

    // ===== Filters =====
    function setupFilters() {
      document.querySelectorAll('.filter-btn[data-range]').forEach(function(btn) {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.filter-btn[data-range]').forEach(function(b) { b.classList.remove('active'); });
          btn.classList.add('active');
          currentRange = btn.getAttribute('data-range');
          updateAllDisplays();
        });
      });

      var exBtn = document.getElementById('exclude-me-btn');
      exBtn.addEventListener('click', function() {
        excludeMyRegion = !excludeMyRegion;
        exBtn.classList.toggle('active', excludeMyRegion);
        updateAllDisplays();
      });
    }

    // ===== Auto-refresh =====
    function setupAutoRefresh() {
      var checkbox = document.getElementById('auto-refresh');
      checkbox.addEventListener('change', function() {
        if (checkbox.checked) {
          refreshTimer = setInterval(loadAllData, 30000);
        } else {
          clearInterval(refreshTimer);
          refreshTimer = null;
        }
      });
    }

    // ===== Util =====
    function escHtml(str) {
      var div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }
  </script>
</body>
</html>

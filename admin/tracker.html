<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visitor Tracker — Salus Admin</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0f1117; color: #e0e0e0; }

    /* Login overlay */
    #login-overlay {
      position: fixed; inset: 0; z-index: 9999;
      background: #0f1117;
      display: flex; align-items: center; justify-content: center;
    }
    .login-box {
      background: #1a1d27; border-radius: 12px; padding: 40px;
      width: 360px; text-align: center; border: 1px solid #2a2d3a;
    }
    .login-box h1 { font-size: 1.4rem; margin-bottom: 8px; color: #fff; }
    .login-box p { font-size: 0.85rem; color: #888; margin-bottom: 24px; }
    .login-box input {
      width: 100%; padding: 12px 16px; margin-bottom: 12px;
      background: #0f1117; border: 1px solid #2a2d3a; border-radius: 8px;
      color: #fff; font-size: 0.95rem; outline: none;
    }
    .login-box input:focus { border-color: #6c63ff; }
    .login-box button {
      width: 100%; padding: 12px; background: #6c63ff; color: #fff;
      border: none; border-radius: 8px; font-size: 0.95rem; cursor: pointer;
      font-weight: 600;
    }
    .login-box button:hover { background: #5a52e0; }
    .login-error { color: #ff6b6b; font-size: 0.85rem; margin-top: 8px; display: none; }

    /* Dashboard */
    #dashboard { display: none; }
    .dash-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 16px 24px; background: #1a1d27; border-bottom: 1px solid #2a2d3a;
    }
    .dash-header h1 { font-size: 1.2rem; color: #fff; }
    .dash-header-right { display: flex; align-items: center; gap: 12px; }
    .visitor-count { font-size: 0.85rem; color: #6c63ff; font-weight: 600; }
    .btn-sm {
      padding: 6px 14px; background: transparent; border: 1px solid #2a2d3a;
      border-radius: 6px; color: #888; font-size: 0.8rem; cursor: pointer;
    }
    .btn-sm:hover { border-color: #6c63ff; color: #6c63ff; }
    .btn-sm.active { background: #6c63ff; border-color: #6c63ff; color: #fff; }

    /* Map */
    #map {
      height: 45vh; margin: 16px 24px;
      border-radius: 12px; border: 1px solid #2a2d3a; overflow: hidden;
    }
    .leaflet-container { background: #1a1d27; }

    /* Table */
    .table-wrap {
      margin: 0 24px 24px; background: #1a1d27;
      border: 1px solid #2a2d3a; border-radius: 10px; overflow: auto;
    }
    table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    th {
      text-align: left; padding: 10px 14px; border-bottom: 1px solid #2a2d3a;
      color: #888; font-weight: 500; font-size: 0.75rem; text-transform: uppercase;
      position: sticky; top: 0; background: #1a1d27;
    }
    td { padding: 8px 14px; border-bottom: 1px solid #1e2130; }
    tr:last-child td { border-bottom: none; }
    .dim { color: #666; }
    .mono { font-family: monospace; font-size: 0.8rem; }
    .no-data { color: #555; font-size: 0.85rem; padding: 24px; text-align: center; }
  </style>
</head>
<body>

  <!-- Login -->
  <div id="login-overlay">
    <div class="login-box">
      <h1>Salus Admin</h1>
      <p>Visitor tracker</p>
      <input type="email" id="login-email" placeholder="Email" autocomplete="email">
      <input type="password" id="login-password" placeholder="Password" autocomplete="current-password">
      <button onclick="doLogin()">Sign In</button>
      <div class="login-error" id="login-error"></div>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard">
    <div class="dash-header">
      <h1>Visitor Tracker <span class="visitor-count" id="visitor-count"></span></h1>
      <div class="dash-header-right">
        <button class="btn-sm active" id="exclude-me-btn">Exclude My Region</button>
        <button class="btn-sm" onclick="doLogout()">Sign Out</button>
      </div>
    </div>

    <div id="map"></div>

    <div class="table-wrap">
      <table id="visitor-table">
        <thead><tr><th>Date</th><th>Location</th><th>Pages Visited</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script>
    var SUPABASE_URL = 'https://egywowuyixfqytaucihf.supabase.co';
    var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVneXdvd3V5aXhmcXl0YXVjaWhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyNzE0OTgsImV4cCI6MjA4NTg0NzQ5OH0.XMA7XDaQocuWQKq6kMuPOy6J3qGJ4k8h5T2p2JdEFJI';
    var sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    var map, markerGroup;
    var excludeMyRegion = true;
    var MY_REGION = { latMin: 53.6, latMax: 53.85, lngMin: -1.7, lngMax: -1.2 };
    var MY_COUNTRY = 'United Kingdom';

    function isMyRegion(r) {
      if (r.latitude && r.longitude) {
        return r.latitude >= MY_REGION.latMin && r.latitude <= MY_REGION.latMax &&
               r.longitude >= MY_REGION.lngMin && r.longitude <= MY_REGION.lngMax;
      }
      return r.country === MY_COUNTRY;
    }

    function applyExclusion(data) {
      if (!excludeMyRegion) return data;
      return data.filter(function(r) { return !isMyRegion(r); });
    }

    // Clean page paths — strip local file prefixes, trailing .html
    function cleanPage(p) {
      if (!p) return '/';
      // Strip local dev paths like /Users/.../salus-website/
      p = p.replace(/^\/Users\/[^/]+\/salus-website\//, '/');
      // Ensure leading slash
      if (p.charAt(0) !== '/') p = '/' + p;
      // Strip .html extension
      p = p.replace(/\.html$/, '');
      // /index → Home
      if (p === '/index' || p === '/') p = 'Home';
      return p;
    }

    // Site filter
    var SRA_FILTER = 'SRA Property Consultants';
    function isSalusPage(r) {
      return !r.page_title || r.page_title.indexOf(SRA_FILTER) === -1;
    }

    // ===== Login =====
    async function doLogin() {
      var email = document.getElementById('login-email').value.trim();
      var password = document.getElementById('login-password').value;
      var errEl = document.getElementById('login-error');
      errEl.style.display = 'none';
      if (!email || !password) { errEl.textContent = 'Enter email and password.'; errEl.style.display = 'block'; return; }
      var { error } = await sb.auth.signInWithPassword({ email: email, password: password });
      if (error) { errEl.textContent = 'Access denied.'; errEl.style.display = 'block'; return; }
      document.getElementById('login-overlay').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      initDashboard();
    }

    async function doLogout() { await sb.auth.signOut(); location.reload(); }

    document.getElementById('login-password').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') doLogin();
    });

    (async function() {
      var { data } = await sb.auth.getSession();
      if (data.session) {
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        initDashboard();
      }
    })();

    // ===== Dashboard =====
    async function initDashboard() {
      initMap();
      await loadData();

      document.getElementById('exclude-me-btn').addEventListener('click', function() {
        excludeMyRegion = !excludeMyRegion;
        this.classList.toggle('active', excludeMyRegion);
        render();
      });
    }

    function initMap() {
      map = L.map('map', { zoomControl: true }).setView([30, 0], 2);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap &copy; CARTO', maxZoom: 18
      }).addTo(map);
      markerGroup = L.markerClusterGroup({
        maxClusterRadius: 50,
        iconCreateFunction: function(cluster) {
          var count = cluster.getChildCount();
          var sz = count < 10 ? 36 : count < 50 ? 46 : 56;
          var fs = sz > 46 ? 14 : 12;
          return L.divIcon({
            html: '<div style="background:rgba(108,99,255,0.85);color:#fff;border-radius:50%;width:'+sz+'px;height:'+sz+'px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:'+fs+'px;border:2px solid rgba(108,99,255,0.4);">'+count+'</div>',
            className: '', iconSize: L.point(sz, sz)
          });
        }
      });
      map.addLayer(markerGroup);
    }

    var allSessions = []; // merged session data for table + map

    async function loadData() {
      var [pvResult, legResult] = await Promise.all([
        sb.from('page_views').select('*').order('created_at', { ascending: false }).limit(5000),
        sb.from('visitor_logs').select('*').order('created_at', { ascending: false }).limit(5000)
      ]);

      var pvData = (pvResult.data || []).filter(isSalusPage);
      var legData = legResult.data || [];

      // Group page_views by session
      var sessionMap = {};

      pvData.forEach(function(pv) {
        var sid = pv.session_id || pv.id;
        if (!sessionMap[sid]) {
          sessionMap[sid] = {
            date: pv.created_at,
            city: pv.city, region: pv.region, country: pv.country,
            latitude: pv.latitude, longitude: pv.longitude,
            pages: []
          };
        }
        var page = cleanPage(pv.page_path);
        if (sessionMap[sid].pages.indexOf(page) === -1) {
          sessionMap[sid].pages.push(page);
        }
        // Use earliest date
        if (pv.created_at < sessionMap[sid].date) sessionMap[sid].date = pv.created_at;
        // Prefer record with geo
        if (!sessionMap[sid].latitude && pv.latitude) {
          sessionMap[sid].latitude = pv.latitude;
          sessionMap[sid].longitude = pv.longitude;
          sessionMap[sid].city = pv.city;
          sessionMap[sid].region = pv.region;
          sessionMap[sid].country = pv.country;
        }
      });

      // Add legacy sessions not already covered
      legData.forEach(function(r) {
        var sid = r.session_id || r.id;
        if (!sessionMap[sid]) {
          sessionMap[sid] = {
            date: r.created_at,
            city: r.city, region: r.region, country: r.country,
            latitude: r.latitude, longitude: r.longitude,
            pages: [cleanPage(r.landing_page)]
          };
        }
      });

      allSessions = Object.values(sessionMap);
      allSessions.sort(function(a, b) { return new Date(b.date) - new Date(a.date); });

      render();
    }

    function render() {
      var filtered = applyExclusion(allSessions);

      // Visitor count
      document.getElementById('visitor-count').textContent = '(' + filtered.length + ' sessions)';

      // Map
      markerGroup.clearLayers();
      filtered.forEach(function(s) {
        if (!s.latitude || !s.longitude) return;
        var marker = L.circleMarker([s.latitude, s.longitude], {
          radius: 6, fillColor: '#6c63ff', color: '#6c63ff',
          weight: 1, opacity: 0.8, fillOpacity: 0.6
        });
        var loc = formatLocation(s);
        var time = formatDate(s.date);
        marker.bindPopup(
          '<div style="font-size:13px;line-height:1.5;">' +
          '<strong>' + escHtml(loc) + '</strong><br>' +
          '<span style="color:#888;">' + time + '</span><br>' +
          escHtml(s.pages.join(', ')) +
          '</div>'
        );
        markerGroup.addLayer(marker);
      });

      // Table
      var tbody = document.querySelector('#visitor-table tbody');
      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3"><div class="no-data">No visitors yet</div></td></tr>';
        return;
      }
      tbody.innerHTML = filtered.map(function(s) {
        var date = formatDate(s.date);
        var loc = formatLocation(s);
        var pages = s.pages.map(function(p) { return escHtml(p); }).join(', ');
        return '<tr><td style="white-space:nowrap;">' + date + '</td>' +
          '<td>' + escHtml(loc) + '</td>' +
          '<td class="mono">' + pages + '</td></tr>';
      }).join('');
    }

    function formatDate(d) {
      var t = new Date(d);
      return t.toLocaleDateString(undefined, { day: 'numeric', month: 'short', year: 'numeric' }) +
        ' ' + t.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
    }

    function formatLocation(s) {
      var parts = [];
      if (s.city) parts.push(s.city);
      if (s.region) parts.push(s.region);
      if (s.country) parts.push(s.country);
      return parts.length > 0 ? parts.join(', ') : 'Unknown';
    }

    function escHtml(str) {
      var div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }
  </script>
</body>
</html>

name: Upload Media to R2

on:
  push:
    branches: [main]
    paths:
      - 'media-upload/**'

jobs:
  upload:
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Upload media files to R2
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          BUCKET="salus-mind"
          STAGING_DIR="media-upload"
          FAILED=0

          if [ ! -d "$STAGING_DIR" ] || [ -z "$(find $STAGING_DIR -type f ! -name '.gitkeep' 2>/dev/null)" ]; then
            echo "No files in media-upload/ — nothing to do."
            exit 0
          fi

          while IFS= read -r -d '' FILE; do
            R2_PATH="${FILE#$STAGING_DIR/}"
            echo "Uploading: $FILE → $BUCKET/$R2_PATH"
            if wrangler r2 object put "$BUCKET/$R2_PATH" --file="$FILE"; then
              echo "✓ Uploaded $R2_PATH"
            else
              echo "✗ FAILED $R2_PATH"
              FAILED=$((FAILED + 1))
            fi
          done < <(find "$STAGING_DIR" -type f ! -name '.gitkeep' -print0)

          if [ "$FAILED" -gt 0 ]; then
            echo "::error::$FAILED file(s) failed to upload"
            exit 1
          fi

      - name: Clean up staging directory
        run: |
          find media-upload -type f ! -name '.gitkeep' -delete
          find media-upload -mindepth 1 -type d -empty -delete

      - name: Commit cleanup
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add media-upload/
          if git diff --cached --quiet; then
            echo "Nothing to clean up."
          else
            git commit -m "chore: clean up media-upload after R2 sync"
            git push
          fi

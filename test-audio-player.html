<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Salus Audio Quality Review</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, Arial, sans-serif;
      padding: 15px;
      background: #1a1a2e;
      color: #fff;
      margin: 0;
    }
    .player { max-width: 1000px; margin: 0 auto; }
    .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
    .header h1 { margin: 0; color: #fff; font-size: 18px; }
    .header .filename { color: #888; font-size: 12px; }

    .top-row { display: flex; gap: 15px; align-items: center; margin-bottom: 10px; }
    .time-display {
      font-size: 36px;
      font-weight: bold;
      font-family: 'SF Mono', 'Monaco', monospace;
      color: #4ade80;
      min-width: 100px;
    }
    .time-display.reviewing { color: #f97316; }
    .current-issue { font-size: 14px; color: #f97316; flex: 1; }

    audio { width: 100%; height: 40px; }

    .controls { display: flex; gap: 8px; margin: 10px 0; flex-wrap: wrap; }
    .control-btn {
      background: #3b82f6;
      border: none;
      color: #fff;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: bold;
    }
    .control-btn:hover { background: #2563eb; }
    .control-btn.active { background: #22c55e; }
    .control-btn.stop { background: #ef4444; }

    .main-content { display: flex; gap: 15px; }
    .issues { flex: 2; background: #2a2a4e; padding: 12px; border-radius: 8px; }
    .issues h3 { margin: 0 0 8px 0; font-size: 13px; color: #888; }
    .issue-list { list-style: none; padding: 0; margin: 0; }
    .issue-list li {
      padding: 6px 8px;
      margin: 4px 0;
      background: #1a1a2e;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      border-left: 3px solid transparent;
    }
    .issue-list li.passed { background: #1a3a1a; border-left-color: #22c55e; }
    .issue-list li.failed { background: #3a1a1a; border-left-color: #ef4444; }
    .issue-list li.current { background: #3a2a1a; border-left-color: #f97316; }

    .issue-time { font-family: monospace; font-weight: bold; min-width: 40px; cursor: pointer; }
    .issue-time:hover { text-decoration: underline; }
    .issue-time.critical { color: #ef4444; }
    .issue-time.high { color: #f97316; }

    .issue-type { font-size: 9px; padding: 2px 4px; border-radius: 3px; font-weight: bold; min-width: 55px; text-align: center; }
    .issue-type.critical { background: #ef4444; }
    .issue-type.high { background: #f97316; }

    .issue-desc { flex: 1; color: #aaa; font-size: 11px; }

    .issue-verdict { display: flex; gap: 4px; }
    .verdict-icon {
      width: 32px;
      height: 28px;
      border-radius: 4px;
      border: 2px solid #444;
      background: #1a1a2e;
      cursor: pointer;
      font-size: 11px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .verdict-icon.pass { border-color: #22c55e; }
    .verdict-icon.pass:hover, .verdict-icon.pass.selected { background: #22c55e; }
    .verdict-icon.fail { border-color: #ef4444; }
    .verdict-icon.fail:hover, .verdict-icon.fail.selected { background: #ef4444; }

    .sidebar { flex: 1; display: flex; flex-direction: column; gap: 10px; }
    .summary { background: #252545; padding: 12px; border-radius: 8px; }
    .summary h3 { margin: 0 0 8px 0; font-size: 13px; }
    .summary-stats { display: flex; gap: 15px; }
    .stat { text-align: center; }
    .stat-num { font-size: 24px; font-weight: bold; }
    .stat-num.pass { color: #22c55e; }
    .stat-num.fail { color: #ef4444; }
    .stat-num.pending { color: #888; }
    .stat-label { font-size: 10px; color: #888; }

    .final-btn {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: bold;
      cursor: pointer;
      background: #3b82f6;
      color: #fff;
      margin-top: 8px;
    }
    .final-btn:hover { background: #2563eb; }

    .results-box {
      margin-top: 8px;
      padding: 8px;
      background: #1a1a2e;
      border-radius: 6px;
      font-family: monospace;
      font-size: 10px;
      white-space: pre-wrap;
      display: none;
      max-height: 150px;
      overflow-y: auto;
    }
    .results-box.visible { display: block; }

    .instructions { font-size: 11px; color: #666; padding: 8px; background: #1a1a2e; border-radius: 6px; }
  </style>
</head>
<body>
  <div class="player">
    <div class="header">
      <h1>Audio Quality Review</h1>
      <div class="filename" id="filename">Loading...</div>
    </div>

    <div class="top-row">
      <div class="time-display" id="timer">0:00</div>
      <div class="current-issue" id="current-issue"></div>
    </div>

    <audio id="audio" controls preload="auto">
      <source id="audio-source" src="" type="audio/mpeg">
    </audio>
    <div id="load-status" style="font-size:11px;color:#666;margin-top:5px;"></div>

    <div class="controls">
      <button class="control-btn" id="auto-review-btn" onclick="toggleAutoReview()">&gt; Auto-Review</button>
      <button class="control-btn" onclick="prevIssue()">&lt;&lt; Prev</button>
      <button class="control-btn" onclick="nextIssue()">Next &gt;&gt;</button>
    </div>

    <div class="main-content">
      <div class="issues">
        <h3>OK = false positive, X = real problem</h3>
        <ul class="issue-list" id="issue-list"></ul>
      </div>

      <div class="sidebar">
        <div class="summary">
          <h3>Summary</h3>
          <div class="summary-stats">
            <div class="stat">
              <div class="stat-num pass" id="pass-count">0</div>
              <div class="stat-label">PASS</div>
            </div>
            <div class="stat">
              <div class="stat-num fail" id="fail-count">0</div>
              <div class="stat-label">FAIL</div>
            </div>
            <div class="stat">
              <div class="stat-num pending" id="pending-count">0</div>
              <div class="stat-label">TODO</div>
            </div>
          </div>
          <button class="final-btn" onclick="copyResults()">Copy Results for Claude</button>
          <div class="results-box" id="results-box"></div>
        </div>
        <div class="instructions">
          <strong>Auto-Review:</strong> Plays 5s around each issue, auto-jumps to next.
        </div>
      </div>
    </div>
  </div>

  <script>
    const reviewData = {
      file: "content/audio-free/mixed/25-introduction-to-mindfulness.mp3",
      filename: "25-introduction-to-mindfulness.mp3 (Build 3 + Stream 3hr @ -14dB)",
      session: "25-introduction-to-mindfulness",
      expected: "~10:00",
      actual: "14:25",
      issues: [
        { id: 1,  time: "00:00", seconds: 0,    severity: "high", type: "OPENING",    desc: "Check opening — soft intro?", verdict: null },
        { id: 2,  time: "00:30", seconds: 30,   severity: "high", type: "TONE",       desc: "Stream ambient fading in — natural?", verdict: null },
        { id: 3,  time: "02:30", seconds: 150,  severity: "high", type: "TONE",       desc: "'breath' section — voice consistent?", verdict: null },
        { id: 4,  time: "04:20", seconds: 260,  severity: "high", type: "TONE",       desc: "'mind will wander' — natural delivery?", verdict: null },
        { id: 5,  time: "05:30", seconds: 330,  severity: "high", type: "SILENCE",    desc: "45s pause — stream continuous?", verdict: null },
        { id: 6,  time: "07:00", seconds: 420,  severity: "high", type: "SILENCE",    desc: "60s pause — stream continuous?", verdict: null },
        { id: 7,  time: "09:00", seconds: 540,  severity: "high", type: "TONE",       desc: "'breaths together' section", verdict: null },
        { id: 8,  time: "10:30", seconds: 630,  severity: "high", type: "SILENCE",    desc: "45s pause — ambient OK?", verdict: null },
        { id: 9,  time: "12:00", seconds: 720,  severity: "high", type: "TONE",       desc: "Closing section — widen awareness", verdict: null },
        { id: 10, time: "13:50", seconds: 830,  severity: "high", type: "CLOSING",    desc: "'Thank you for practicing with Salus'", verdict: null },
        { id: 11, time: "14:10", seconds: 850,  severity: "high", type: "CLOSING",    desc: "'Sleep, relax, restore' — clean end?", verdict: null }
      ]
    };

    let autoReviewMode = false;
    let currentIssueIndex = -1;
    let playUntil = null;
    let isAdvancing = false;  // Prevent double-advance

    const audio = document.getElementById('audio');
    const timer = document.getElementById('timer');
    const audioSource = document.getElementById('audio-source');
    const filenameEl = document.getElementById('filename');
    const issueList = document.getElementById('issue-list');
    const passCount = document.getElementById('pass-count');
    const failCount = document.getElementById('fail-count');
    const pendingCount = document.getElementById('pending-count');
    const resultsBox = document.getElementById('results-box');
    const currentIssueEl = document.getElementById('current-issue');
    const autoReviewBtn = document.getElementById('auto-review-btn');

    audioSource.src = reviewData.file;
    filenameEl.textContent = `${reviewData.filename} (Expected: ${reviewData.expected}, Actual: ${reviewData.actual})`;

    const loadStatus = document.getElementById('load-status');
    loadStatus.textContent = 'Loading audio...';

    audio.load();

    audio.addEventListener('canplaythrough', () => {
      loadStatus.textContent = 'Audio ready - seeking enabled';
      loadStatus.style.color = '#4ade80';
    });

    audio.addEventListener('progress', () => {
      if (audio.buffered.length > 0) {
        const bufferedEnd = audio.buffered.end(audio.buffered.length - 1);
        const duration = audio.duration;
        const percent = Math.round((bufferedEnd / duration) * 100);
        loadStatus.textContent = `Buffering: ${percent}%`;
      }
    });

    reviewData.issues.sort((a, b) => a.seconds - b.seconds);

    reviewData.issues.forEach((issue, idx) => {
      const li = document.createElement('li');
      li.id = `issue-${issue.id}`;
      li.dataset.index = idx;
      li.innerHTML = `
        <span class="issue-time ${issue.severity}" onclick="jumpToIssue(${idx})">${issue.time}</span>
        <span class="issue-type ${issue.severity}">${issue.type}</span>
        <span class="issue-desc">${issue.desc}</span>
        <div class="issue-verdict">
          <button class="verdict-icon pass" onclick="setVerdict(${issue.id}, 'pass')">OK</button>
          <button class="verdict-icon fail" onclick="setVerdict(${issue.id}, 'fail')">X</button>
        </div>
      `;
      issueList.appendChild(li);
    });

    updateCounts();

    audio.ontimeupdate = function() {
      const mins = Math.floor(audio.currentTime / 60);
      const secs = Math.floor(audio.currentTime % 60);
      timer.textContent = mins + ':' + secs.toString().padStart(2, '0');

      if (autoReviewMode && playUntil !== null && audio.currentTime >= playUntil && !isAdvancing) {
        isAdvancing = true;
        playUntil = null;
        audio.pause();
        setTimeout(() => {
          if (autoReviewMode) nextIssue();
          isAdvancing = false;
        }, 500);
      }
    };

    function jumpToIssue(idx) {
      currentIssueIndex = idx;
      const issue = reviewData.issues[idx];

      document.querySelectorAll('.issue-list li').forEach(li => li.classList.remove('current'));
      document.getElementById(`issue-${issue.id}`).classList.add('current');

      timer.classList.add('reviewing');

      const startTime = Math.max(0, issue.seconds - 2);
      playUntil = issue.seconds + 3;

      currentIssueEl.textContent = `Seeking to ${issue.time}...`;

      // Stop current playback
      audio.pause();

      // Use fastSeek if available, otherwise currentTime
      if (audio.fastSeek) {
        audio.fastSeek(startTime);
      } else {
        audio.currentTime = startTime;
      }

      // Wait a moment for seek to take effect, then play
      setTimeout(() => {
        // Verify seek worked
        const actualTime = Math.floor(audio.currentTime);
        const expectedTime = Math.floor(startTime);
        if (Math.abs(actualTime - expectedTime) > 5) {
          currentIssueEl.textContent = `SEEK FAILED: wanted ${startTime}s, got ${audio.currentTime}s`;
          currentIssueEl.style.color = '#ef4444';
        } else {
          currentIssueEl.textContent = `Reviewing: ${issue.time} - ${issue.type}`;
          currentIssueEl.style.color = '#f97316';
        }
        audio.play();
      }, 200);
    }

    function nextIssue() {
      if (currentIssueIndex < reviewData.issues.length - 1) {
        jumpToIssue(currentIssueIndex + 1);
      } else {
        stopAutoReview();
        currentIssueEl.textContent = 'Review complete!';
      }
    }

    function prevIssue() {
      if (currentIssueIndex > 0) jumpToIssue(currentIssueIndex - 1);
    }

    function toggleAutoReview() {
      autoReviewMode ? stopAutoReview() : startAutoReview();
    }

    function startAutoReview() {
      autoReviewMode = true;
      autoReviewBtn.textContent = '[] Stop';
      autoReviewBtn.classList.add('stop');
      jumpToIssue(0);
    }

    function stopAutoReview() {
      autoReviewMode = false;
      autoReviewBtn.textContent = '> Auto-Review';
      autoReviewBtn.classList.remove('stop');
      playUntil = null;
      audio.pause();
      timer.classList.remove('reviewing');
      currentIssueEl.textContent = '';
      document.querySelectorAll('.issue-list li').forEach(li => li.classList.remove('current'));
    }

    function setVerdict(id, verdict) {
      const issue = reviewData.issues.find(i => i.id === id);
      if (issue) {
        issue.verdict = verdict;
        const li = document.getElementById(`issue-${id}`);
        li.classList.remove('passed', 'failed');
        li.classList.add(verdict === 'pass' ? 'passed' : 'failed');

        li.querySelector('.verdict-icon.pass').classList.toggle('selected', verdict === 'pass');
        li.querySelector('.verdict-icon.fail').classList.toggle('selected', verdict === 'fail');

        updateCounts();

        if (autoReviewMode && !isAdvancing) {
          isAdvancing = true;
          // Stop current playback
          audio.pause();
          playUntil = null;

          // Find this issue's index and set currentIssueIndex
          const issueIndex = reviewData.issues.findIndex(i => i.id === id);
          if (issueIndex !== -1) {
            currentIssueIndex = issueIndex;
          }

          setTimeout(() => {
            nextIssue();
            isAdvancing = false;
          }, 300);
        }
      }
    }

    function updateCounts() {
      passCount.textContent = reviewData.issues.filter(i => i.verdict === 'pass').length;
      failCount.textContent = reviewData.issues.filter(i => i.verdict === 'fail').length;
      pendingCount.textContent = reviewData.issues.filter(i => i.verdict === null).length;
    }

    function copyResults() {
      const passed = reviewData.issues.filter(i => i.verdict === 'pass');
      const failed = reviewData.issues.filter(i => i.verdict === 'fail');
      const pending = reviewData.issues.filter(i => i.verdict === null);

      let result = `HUMAN REVIEW: ${reviewData.session}\n`;
      result += `File: ${reviewData.filename}\n`;
      result += `SUMMARY: ${passed.length} OK, ${failed.length} FAILED, ${pending.length} pending\n\n`;

      if (failed.length > 0) {
        result += `FAILED:\n`;
        failed.forEach(i => result += `  X ${i.time} ${i.type}: ${i.desc}\n`);
        result += `\n`;
      }
      if (passed.length > 0) {
        result += `PASSED:\n`;
        passed.forEach(i => result += `  OK ${i.time} ${i.type}\n`);
        result += `\n`;
      }
      if (pending.length > 0) {
        result += `NOT REVIEWED:\n`;
        pending.forEach(i => result += `  ? ${i.time} ${i.type}\n`);
        result += `\n`;
      }

      if (failed.length === 0 && pending.length === 0) {
        result += `VERDICT: PASS - Deploy this file\n`;
      } else if (failed.length > 0) {
        result += `VERDICT: FAIL - Rebuild required\n`;
      } else {
        result += `VERDICT: INCOMPLETE\n`;
      }

      resultsBox.textContent = result;
      resultsBox.classList.add('visible');
      navigator.clipboard.writeText(result).then(() => alert('Copied! Paste into Claude.'));
    }
  </script>
</body>
</html>
